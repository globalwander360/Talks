package com.example.strategy;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.Mockito;

import java.io.File;
import java.util.List;
import java.util.Set;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

class XalStrategyContextTest {

    private XalStrategyContext xalStrategyContext;
    private XalStrategy<TnxRecord> mockStrategy;
    private ExternalTNTRequest mockRequest;

    @BeforeEach
    void setUp() {
        mockStrategy = Mockito.mock(XalStrategy.class);
        when(mockStrategy.getProductCode()).thenReturn("EXPORT_COLLECTION");

        xalStrategyContext = new XalStrategyContext(Set.of(mockStrategy));

        mockRequest = new ExternalTNTRequest("EXPORT_COLLECTION");
    }

    @Test
    void testGenerateXml_ShouldCallCorrectStrategy() {
        File expectedFile = new File("test.xml");

        when(mockStrategy.generateXml(any(), any(), any())).thenReturn(expectedFile);

        File actualFile = xalStrategyContext.generateXml(mockRequest, "test.xml", List.of());

        assertEquals(expectedFile, actualFile);
        verify(mockStrategy, times(1)).generateXml(eq(mockRequest), eq("test.xml"), any());
    }

    @Test
    void testGenerateXml_WhenNoStrategyFound_ShouldThrowNullPointerException() {
        ExternalTNTRequest unknownRequest = new ExternalTNTRequest("UNKNOWN");

        assertThrows(NullPointerException.class, () ->
                xalStrategyContext.generateXml(unknownRequest, "test.xml", List.of())
        );
    }

    @Test
    void testConstructor_ShouldStoreStrategiesByProductCode() {
        assertNotNull(xalStrategyContext);
    }
}
